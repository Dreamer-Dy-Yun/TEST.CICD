# CD (Continuous Deployment) 워크플로우
# 코드 푸시 시 자동으로 로컬 PC에 배포합니다
name: Deploy FastAPI Application

# 워크플로우 실행 트리거 설정
on:
  # main, master 브랜치에 푸시할 때 자동 실행
  push:
    branches: [ main, master ]
  # GitHub Actions 탭에서 수동 실행 가능
  workflow_dispatch:

# 실행할 작업 정의
jobs:
  deploy:
    # self-hosted: 로컬 PC에 설치한 GitHub Actions Runner에서 실행
    # (로컬 PC의 파일 시스템에 접근하여 배포 가능)
    # 주의: Runner를 먼저 설치해야 함 (DEPLOYMENT_GUIDE.md 참고)
    runs-on: self-hosted
    
    # 작업 실행 단계들
    steps:
      # 1단계: GitHub 저장소에서 코드 체크아웃
      # (로컬 PC의 Runner가 코드를 가져옴)
      - name: Checkout code
        uses: actions/checkout@v3
      
      # 2단계: Python 버전 확인
      # 시스템에 설치된 Python 사용 (관리자 권한 불필요)
      - name: Check Python version
        run: |
          python --version
          pip --version
      
      # 3단계: 프로젝트 의존성 설치 (임시)
      # 체크아웃된 코드에서 의존성 확인용
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4단계: 배포 디렉토리 생성
      # 배포할 파일들을 저장할 디렉토리 생성
      # 경로: C:\Users\윤대영\Desktop\test\deploy
      - name: Create deployment directory
        run: |
          $deployPath = "$env:USERPROFILE\Desktop\test\deploy"
          # 디렉토리가 없으면 생성
          if (-not (Test-Path $deployPath)) {
            New-Item -ItemType Directory -Path $deployPath -Force
          }
      
      # 5단계: 배포 디렉토리로 파일 복사
      # 필요한 파일들을 배포 디렉토리로 복사
      # -Force: 기존 파일이 있으면 덮어쓰기
      - name: Copy files to deployment directory
        run: |
          $deployPath = "$env:USERPROFILE\Desktop\test\deploy"
          Copy-Item -Path "main.py" -Destination "$deployPath\main.py" -Force
          Copy-Item -Path "requirements.txt" -Destination "$deployPath\requirements.txt" -Force
      
      # 6단계: 배포 디렉토리에서 가상환경 생성 및 의존성 설치
      # 배포 환경에 가상환경을 만들고 필요한 패키지 설치
      - name: Create virtual environment and install dependencies
        run: |
          $deployPath = "$env:USERPROFILE\Desktop\test\deploy"
          Set-Location $deployPath
          
          # Python 경로 찾기
          $pythonPaths = @(
            "C:\Users\$env:USERNAME\AppData\Local\Programs\Python\Python313\python.exe",
            "C:\Users\$env:USERNAME\AppData\Local\Programs\Python\Python312\python.exe",
            (Get-Command python -ErrorAction SilentlyContinue).Source
          )
          $pythonPath = $null
          foreach ($path in $pythonPaths) {
            if ($path -and (Test-Path $path)) {
              $pythonPath = $path
              break
            }
          }
          if (-not $pythonPath) {
            Write-Error "Python을 찾을 수 없습니다."
            exit 1
          }
          
          # 가상환경이 없으면 생성
          if (-not (Test-Path "venv")) {
            Write-Host "가상환경 생성 중..."
            & $pythonPath -m venv venv
          }
          
          # 가상환경 활성화 및 의존성 설치
          Write-Host "의존성 설치 중..."
          & ".\venv\Scripts\python.exe" -m pip install --upgrade pip
          & ".\venv\Scripts\pip.exe" install -r requirements.txt
      
      # 7단계: 기존 애플리케이션 중지
      # 배포 디렉토리에서 실행 중인 애플리케이션만 종료 (다른 Python 프로세스는 유지)
      - name: Stop existing application (if running)
        run: |
          $deployPath = "$env:USERPROFILE\Desktop\test\deploy"
          # 배포 디렉토리에서 실행 중인 Python 프로세스만 찾아서 종료
          $processes = Get-Process | Where-Object {
            ($_.ProcessName -like "*python*") -and 
            ($_.Path -like "*$deployPath*" -or $_.CommandLine -like "*$deployPath*")
          }
          if ($processes) {
            Write-Host "기존 애플리케이션 종료 중..."
            $processes | Stop-Process -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 2
          } else {
            Write-Host "실행 중인 애플리케이션이 없습니다."
          }
      
      # 8단계: 새 버전 애플리케이션 실행
      # 배포 디렉토리에서 가상환경의 Python을 사용하여 FastAPI 애플리케이션 시작
      # -WindowStyle Hidden: 백그라운드에서 실행 (창이 보이지 않음)
      - name: Start application
        run: |
          $deployPath = "$env:USERPROFILE\Desktop\test\deploy"
          
          # 가상환경의 Python 사용 (전체 경로)
          $venvPython = "$deployPath\venv\Scripts\python.exe"
          $mainPy = "$deployPath\main.py"
          
          if (-not (Test-Path $venvPython)) {
            Write-Error "가상환경을 찾을 수 없습니다: $venvPython"
            exit 1
          }
          
          if (-not (Test-Path $mainPy)) {
            Write-Error "main.py 파일을 찾을 수 없습니다: $mainPy"
            exit 1
          }
          
          Write-Host "애플리케이션 시작 중..."
          Write-Host "Python 경로: $venvPython"
          Write-Host "메인 파일: $mainPy"
          Write-Host "작업 디렉토리: $deployPath"
          
          # 애플리케이션 시작 (전체 경로 사용)
          $process = Start-Process -FilePath $venvPython -ArgumentList $mainPy -WorkingDirectory $deployPath -WindowStyle Hidden -PassThru
          
          if ($process) {
            Write-Host "프로세스 ID: $($process.Id)"
            Start-Sleep -Seconds 5
            
            # 프로세스가 여전히 실행 중인지 확인
            $running = Get-Process -Id $process.Id -ErrorAction SilentlyContinue
            if ($running) {
              Write-Host "✅ 애플리케이션이 성공적으로 시작되었습니다."
              
              # 포트 8000이 열렸는지 확인
              Start-Sleep -Seconds 2
              $portCheck = Test-NetConnection -ComputerName localhost -Port 8000 -InformationLevel Quiet -WarningAction SilentlyContinue
              if ($portCheck) {
                Write-Host "✅ 포트 8000이 열렸습니다."
              } else {
                Write-Warning "⚠️ 포트 8000이 아직 열리지 않았습니다. 잠시 후 다시 확인하세요."
              }
            } else {
              Write-Error "❌ 애플리케이션이 시작 후 종료되었습니다. 로그를 확인하세요."
              exit 1
            }
          } else {
            Write-Error "❌ 애플리케이션 시작 실패"
            exit 1
          }
      
      # 9단계: 배포 완료 메시지
      # 배포가 성공적으로 완료되었음을 알림
      - name: Deployment complete
        run: |
          Write-Host "배포가 완료되었습니다!"
          Write-Host "애플리케이션은 http://localhost:8000 에서 실행 중입니다."

